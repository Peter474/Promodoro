<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Focus Timer</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e8b86d">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Focus Timer">
<link rel="apple-touch-icon" href="fo.png">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700;900&family=Playfair+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a12;--surface:#12121f;--card:#1a1a2e;
  --accent:#e8b86d;--accent2:#7eb8d4;
  --text:#f0ede8;--muted:#6b6880;--success:#7de8a0;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  background:var(--bg);color:var(--text);
  font-family:'DM Sans',sans-serif;
  min-height:100vh;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  overflow-x:hidden;position:relative;
}
.bg-orbs{position:fixed;inset:0;pointer-events:none;z-index:0;}
.orb{position:absolute;border-radius:50%;filter:blur(80px);opacity:.12;animation:orbFloat 8s ease-in-out infinite;}
.orb1{width:400px;height:400px;background:var(--accent);top:-100px;right:-100px;}
.orb2{width:350px;height:350px;background:var(--accent2);bottom:-80px;left:-80px;animation-delay:-3s;}
.orb3{width:200px;height:200px;background:#9b7de8;top:50%;left:50%;animation:orbFloat3 8s ease-in-out infinite;animation-delay:-5s;}
@keyframes orbFloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-30px) scale(1.05)}}
@keyframes orbFloat3{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-60%) scale(1.1)}}

.container{position:relative;z-index:1;width:100%;max-width:500px;padding:20px 20px 80px;
  display:flex;flex-direction:column;align-items:center;gap:18px;}

.header{text-align:center;}
.header .sub{font-size:11px;letter-spacing:5px;text-transform:uppercase;color:var(--accent);font-weight:300;margin-bottom:4px;}
.header h1{font-family:'Playfair Display',serif;font-size:26px;font-weight:400;font-style:italic;opacity:.9;}

.mode-tabs{display:flex;background:var(--card);border-radius:50px;padding:4px;gap:2px;border:1px solid rgba(255,255,255,.05);}
.mode-tab{padding:8px 16px;border-radius:50px;border:none;background:transparent;color:var(--muted);
  font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;transition:all .3s;white-space:nowrap;}
.mode-tab.active{background:var(--accent);color:#0a0a12;font-weight:700;}

.timer-wrap{position:relative;display:flex;align-items:center;justify-content:center;}
.timer-svg{transform:rotate(-90deg);filter:drop-shadow(0 0 20px rgba(232,184,109,.2));}
.timer-bg-circle{fill:none;stroke:rgba(255,255,255,.04);stroke-width:6;}
.timer-progress{fill:none;stroke:var(--accent);stroke-width:6;stroke-linecap:round;transition:stroke-dashoffset 1s linear,stroke .5s;}
.timer-center{position:absolute;display:flex;flex-direction:column;align-items:center;gap:4px;}
.timer-display{font-size:64px;font-weight:900;letter-spacing:-2px;line-height:1;font-variant-numeric:tabular-nums;}
.timer-label{font-size:11px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;}
.session-count{font-size:11px;color:var(--accent);margin-top:2px;}

.pomo-dots{display:flex;gap:8px;}
.pomo-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.1);transition:all .3s;}
.pomo-dot.done{background:var(--accent);border-color:var(--accent);}
.pomo-dot.current{background:transparent;border-color:var(--accent);box-shadow:0 0 8px var(--accent);animation:pulse 1.5s ease-in-out infinite;}
@keyframes pulse{0%,100%{box-shadow:0 0 4px var(--accent)}50%{box-shadow:0 0 12px var(--accent)}}

.controls{display:flex;align-items:center;gap:16px;}
.btn-sec{width:48px;height:48px;border-radius:50%;border:1px solid rgba(255,255,255,.1);background:var(--card);
  color:var(--muted);font-size:18px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;}
.btn-sec:hover{border-color:var(--accent);color:var(--accent);transform:scale(1.05);}
.btn-play{width:80px;height:80px;border-radius:50%;border:none;background:var(--accent);color:#0a0a12;font-size:28px;
  cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 30px rgba(232,184,109,.3),0 8px 20px rgba(0,0,0,.4);}
.btn-play:hover{transform:scale(1.08);}
.btn-play:active{transform:scale(.97);}
.btn-play.running{background:var(--surface);color:var(--accent);border:2px solid var(--accent);}

.panel{width:100%;background:var(--card);border-radius:20px;border:1px solid rgba(255,255,255,.05);padding:16px 20px;}
.panel-title{font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
.panel-title em{color:var(--accent2);font-style:normal;font-size:10px;letter-spacing:1px;}

.music-now{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.music-icon{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--accent2),#5a9db8);
  display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.music-info{flex:1;}
.music-name{font-size:14px;font-weight:500;}
.music-desc{font-size:11px;color:var(--muted);margin-top:2px;}

.eq{display:flex;align-items:flex-end;gap:2px;height:16px;}
.eq-bar{width:3px;background:var(--accent2);border-radius:2px;animation:eqA .8s ease-in-out infinite;}
.eq-bar:nth-child(1){height:6px;animation-delay:0s}
.eq-bar:nth-child(2){height:12px;animation-delay:.1s}
.eq-bar:nth-child(3){height:8px;animation-delay:.2s}
.eq-bar:nth-child(4){height:14px;animation-delay:.15s}
.eq-bar:nth-child(5){height:6px;animation-delay:.05s}
@keyframes eqA{0%,100%{transform:scaleY(1)}50%{transform:scaleY(.2)}}
.eq.paused .eq-bar{animation-play-state:paused;}

.sound-grid{display:flex;gap:8px;flex-wrap:wrap;}
.snd-btn{padding:8px 16px;border-radius:50px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);
  color:var(--muted);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;
  transition:all .25s;display:flex;align-items:center;gap:5px;}
.snd-btn:hover{border-color:var(--accent2);color:var(--accent2);}
.snd-btn.on{background:rgba(126,184,212,.18);border-color:var(--accent2);color:var(--accent2);
  box-shadow:0 0 14px rgba(126,184,212,.2);}

.vol-row{display:flex;align-items:center;gap:10px;margin-top:14px;}
.vol-row span{font-size:14px;color:var(--muted);}
input[type=range]{flex:1;-webkit-appearance:none;height:3px;border-radius:2px;background:rgba(255,255,255,.1);outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent2);box-shadow:0 0 6px rgba(126,184,212,.5);}

.set-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04);}
.set-row:last-child{border-bottom:none;}
.set-label{font-size:13px;color:var(--muted);font-weight:500;}
.time-adj{display:flex;align-items:center;gap:8px;}
.t-btn{width:28px;height:28px;border-radius:50%;border:1px solid rgba(255,255,255,.1);background:transparent;
  color:var(--text);font-size:16px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;}
.t-btn:hover{border-color:var(--accent);color:var(--accent);}
.t-inp{width:52px;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);
  color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;text-align:center;outline:none;}
.t-inp:focus{border-color:var(--accent);}
.t-unit{font-size:11px;color:var(--muted);}

/* Stats bar */
.stats-bar{width:100%;display:flex;gap:10px;}
.stat-card{flex:1;background:var(--card);border-radius:16px;border:1px solid rgba(255,255,255,.05);padding:14px 16px;text-align:center;}
.stat-num{font-size:28px;font-weight:900;color:var(--accent);}
.stat-lbl{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:2px;}

/* Guard */
.guard{display:none;position:fixed;inset:0;background:rgba(10,10,18,.97);z-index:1000;
  flex-direction:column;align-items:center;justify-content:center;gap:20px;backdrop-filter:blur(10px);}
.guard.show{display:flex;}
.g-emoji{font-size:64px;animation:shake .5s ease-in-out;}
@keyframes shake{0%,100%{transform:rotate(0)}25%{transform:rotate(-10deg)}75%{transform:rotate(10deg)}}
.g-title{font-size:26px;font-weight:900;text-align:center;}
.g-sub{font-size:15px;color:var(--muted);text-align:center;max-width:300px;line-height:1.6;}
.g-count{font-size:52px;font-weight:900;color:var(--accent);font-family:'Playfair Display',serif;}
.g-btns{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
.g-stay{padding:12px 30px;border-radius:50px;border:none;background:var(--accent);color:#0a0a12;
  font-family:'DM Sans',sans-serif;font-size:16px;font-weight:700;cursor:pointer;}
.g-leave{padding:12px 30px;border-radius:50px;border:1px solid var(--muted);background:transparent;
  color:var(--muted);font-family:'DM Sans',sans-serif;font-size:16px;cursor:pointer;}

/* Install banner */
.install-bar{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--card);
  border-top:1px solid rgba(232,184,109,.25);padding:14px 20px;
  flex-direction:row;align-items:center;justify-content:space-between;gap:12px;z-index:500;}
.install-bar.show{display:flex;}
.install-txt{font-size:13px;color:var(--text);}
.install-txt strong{color:var(--accent);}
.install-btn{padding:8px 20px;border-radius:50px;border:none;background:var(--accent);color:#0a0a12;
  font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;}
.install-close{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:4px;}

/* Toast */
.toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%) translateY(100px);
  background:var(--card);border:1px solid var(--accent);color:var(--text);
  padding:12px 24px;border-radius:50px;font-size:14px;z-index:999;
  transition:transform .3s ease;text-align:center;white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}

body.break-mode .timer-progress{stroke:var(--success);}
body.break-mode .btn-play{background:var(--success);}
  /* Responsive Fix for Mobile */
@media (max-width: 500px) {

  .container {
    padding: 16px 12px 90px;
  }

  .stats-bar {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
  }

  .stat-card {
    padding: 10px 6px;
  }

  .stat-num {
    font-size: 20px;
  }

  .stat-lbl {
    font-size: 8px;
    letter-spacing: 1px;
  }

  .session-count {
    font-size: 9px;
  }

}
}
</style>
</head>
<body>
<div class="bg-orbs">
  <div class="orb orb1"></div><div class="orb orb2"></div><div class="orb orb3"></div>
</div>

<div class="guard" id="guard">
  <div class="g-emoji">ğŸš«</div>
  <div class="g-title">Hey! You're still studying!</div>
  <div class="g-sub">You switched tabs during a focus session. Get back to work!</div>
  <div class="g-count" id="gCount">5</div>
  <div class="g-btns">
    <button class="g-stay" onclick="returnToStudy()">âœ… Back to Studying</button>
    <button class="g-leave" onclick="forceLeave()">Leave Anyway</button>
  </div>
</div>

<div class="install-bar" id="installBar">
  <div class="install-txt">ğŸ“² <strong>Install Focus Timer</strong> â€” add to home screen</div>
  <button class="install-btn" onclick="doInstall()">Install</button>
  <button class="install-close" onclick="dismissInstall()">âœ•</button>
</div>

<div class="toast" id="toast"></div>

<div class="container">
  <div class="header">
    <div class="sub">â³ Deep Work</div>
    <h1>Focus Session</h1>
  </div>

  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-num" id="statToday">0</div>
      <div class="stat-lbl">Today ğŸ…</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" id="statTotal">0</div>
      <div class="stat-lbl">All Time</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" id="statStreak">0</div>
      <div class="stat-lbl">Day Streak ğŸ”¥</div>
    </div>
  </div>

  <div class="mode-tabs">
    <button class="mode-tab active" onclick="setMode('focus',this)">ğŸ¯ Focus</button>
    <button class="mode-tab" onclick="setMode('short',this)">â˜• Short Break</button>
    <button class="mode-tab" onclick="setMode('long',this)">ğŸŒ´ Long Break</button>
  </div>

  <div class="timer-wrap">
    <svg class="timer-svg" width="240" height="240" viewBox="0 0 240 240">
      <circle class="timer-bg-circle" cx="120" cy="120" r="108"/>
      <circle class="timer-progress" id="timerProgress" cx="120" cy="120" r="108"
        stroke-dasharray="678.6" stroke-dashoffset="0"/>
    </svg>
    <div class="timer-center">
      <div class="timer-display" id="timerDisplay">50:00</div>
      <div class="timer-label" id="timerLabel">DEEP FOCUS</div>
      <div class="session-count" id="sessionCount">Session 1 of 4 ğŸ…</div>
    </div>
  </div>

  <div class="pomo-dots" id="pomoDots">
    <div class="pomo-dot current"></div>
    <div class="pomo-dot"></div>
    <div class="pomo-dot"></div>
    <div class="pomo-dot"></div>
  </div>

  <div class="controls">
    <button class="btn-sec" onclick="resetTimer()" title="Reset">â†º</button>
    <button class="btn-play" id="startBtn" onclick="toggleTimer()">â–¶</button>
    <button class="btn-sec" onclick="skipSession()" title="Skip">â­</button>
  </div>

  <!-- Music -->
  <div class="panel">
    <div class="panel-title">ğŸµ Ambient Sound &nbsp;<em>â€” tap to play Â· tap again to stop</em></div>
    <div class="music-now">
      <div class="music-icon">ğŸ¶</div>
      <div class="music-info">
        <div class="music-name" id="musicName">No sound selected</div>
        <div class="music-desc" id="musicDesc">Tap a sound below</div>
      </div>
      <div class="eq paused" id="eq">
        <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
        <div class="eq-bar"></div><div class="eq-bar"></div>
      </div>
    </div>
    <div class="sound-grid">
      <button class="snd-btn" id="sb-rain"   onclick="toggleSound(this,'rain')">ğŸŒ§ï¸ Rain</button>
      <button class="snd-btn" id="sb-ocean"  onclick="toggleSound(this,'ocean')">ğŸŒŠ Ocean</button>
      <button class="snd-btn" id="sb-forest" onclick="toggleSound(this,'forest')">ğŸŒ¿ Forest</button>
      <button class="snd-btn" id="sb-fire"   onclick="toggleSound(this,'fire')">ğŸ”¥ Fireplace</button>
      <button class="snd-btn" id="sb-space"  onclick="toggleSound(this,'space')">ğŸŒŒ Space</button>
    </div>
    <div class="vol-row">
      <span>ğŸ”‡</span>
      <input type="range" min="0" max="1" step="0.02" value="0.45" id="volSlider" oninput="setVol(this.value)">
      <span>ğŸ”Š</span>
    </div>
  </div>

  <!-- Settings -->
  <div class="panel">
    <div class="panel-title">âš™ï¸ Duration Settings</div>
    <div class="set-row">
      <span class="set-label">ğŸ¯ Focus duration</span>
      <div class="time-adj">
        <button class="t-btn" onclick="adj('focus',-5)">âˆ’</button>
        <input class="t-inp" type="number" id="focusInput" value="50" min="1" max="180" onchange="inp('focus',this.value)">
        <span class="t-unit">min</span>
        <button class="t-btn" onclick="adj('focus',5)">+</button>
      </div>
    </div>
    <div class="set-row">
      <span class="set-label">â˜• Short break</span>
      <div class="time-adj">
        <button class="t-btn" onclick="adj('short',-1)">âˆ’</button>
        <input class="t-inp" type="number" id="shortInput" value="10" min="1" max="60" onchange="inp('short',this.value)">
        <span class="t-unit">min</span>
        <button class="t-btn" onclick="adj('short',1)">+</button>
      </div>
    </div>
    <div class="set-row">
      <span class="set-label">ğŸŒ´ Long break</span>
      <div class="time-adj">
        <button class="t-btn" onclick="adj('long',-5)">âˆ’</button>
        <input class="t-inp" type="number" id="longInput" value="20" min="1" max="120" onchange="inp('long',this.value)">
        <span class="t-unit">min</span>
        <button class="t-btn" onclick="adj('long',5)">+</button>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE  â€” save & load everything from localStorage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LS = {
  save(key, val) { try { localStorage.setItem('ft_'+key, JSON.stringify(val)); } catch(e){} },
  load(key, def) { try { const v = localStorage.getItem('ft_'+key); return v !== null ? JSON.parse(v) : def; } catch(e){ return def; } }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE  â€” all loaded from localStorage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = LS.load('settings', { focus:50, short:10, long:20 });
let mode         = 'focus';
let timeLeft     = S.focus * 60;
let totalTime    = S.focus * 60;
let running      = false;
let ticker       = null;
let completedSessions = 0;

// Stats â€” persisted
let stats = LS.load('stats', { total:0, todayDate:'', todayCount:0, streak:0, lastDate:'' });
const todayStr = new Date().toDateString();
if (stats.todayDate !== todayStr) { stats.todayDate = todayStr; stats.todayCount = 0; }

// Sound & volume â€” persisted
const savedSound = LS.load('sound', null);
const savedVol   = LS.load('vol', 0.45);

// Guard
let guardTick = null, guardVal = 5;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let AC = null, MG = null;
let activeSrc = null;
let stopFns = [];
let vol = savedVol;

function initAC() {
  if (AC) { AC.resume(); return; }
  AC = new (window.AudioContext || window.webkitAudioContext)();
  MG = AC.createGain();
  MG.gain.value = vol;
  MG.connect(AC.destination);
}

function stopSound() {
  stopFns.forEach(fn => { try { fn(); } catch(e){} });
  stopFns = [];
  activeSrc = null;
}

function buildNoiseBuffer(type, durationSecs) {
  const sr = AC.sampleRate;
  const len = Math.floor(sr * durationSecs);
  const buf = AC.createBuffer(2, len, sr);
  for (let c = 0; c < 2; c++) {
    const d = buf.getChannelData(c);
    if (type === 'pink') {
      let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
      for (let i = 0; i < len; i++) {
        const w = Math.random() * 2 - 1;
        b0 = 0.99886*b0 + w*0.0555179; b1 = 0.99332*b1 + w*0.0750759;
        b2 = 0.96900*b2 + w*0.1538520; b3 = 0.86650*b3 + w*0.3104856;
        b4 = 0.55000*b4 + w*0.5329522; b5 = -0.7616*b5 - w*0.0168980;
        d[i] = (b0+b1+b2+b3+b4+b5+b6+w*0.5362) * 0.10;
        b6 = w * 0.115926;
      }
    } else {
      let last = 0;
      for (let i = 0; i < len; i++) {
        const w = Math.random() * 2 - 1;
        d[i] = (last + 0.018*w) / 1.018; last = d[i]; d[i] *= 3.0;
      }
    }
    const xf = Math.floor(sr * 0.08);
    for (let i = 0; i < xf; i++) { d[i] *= i/xf; d[len-1-i] *= i/xf; }
  }
  return buf;
}

function mkSrc(type, secs) {
  const src = AC.createBufferSource();
  src.buffer = buildNoiseBuffer(type, secs);
  src.loop = true; return src;
}
function mkF(type, freq, Q, g) {
  const f = AC.createBiquadFilter(); f.type = type; f.frequency.value = freq;
  if (Q != null) f.Q.value = Q; if (g != null) f.gain.value = g; return f;
}
function mkG(v) { const g = AC.createGain(); g.gain.value = v; return g; }

// â”€â”€ RAIN: Pink noise, soft lowpass â”€â”€
function startRain() {
  const src = mkSrc('pink', 10);
  const hp = mkF('highpass', 80, 0.4);
  const lp1 = mkF('lowpass', 1400, 0.5);
  const lp2 = mkF('lowpass', 700, 0.4);
  const g = mkG(0.75);
  src.connect(hp); hp.connect(lp1); lp1.connect(lp2); lp2.connect(g); g.connect(MG);
  src.start();
  stopFns.push(() => { try { src.stop(); } catch(e){} });
}

// â”€â”€ OCEAN: Brown noise + slow LFO tremolo â”€â”€
function startOcean() {
  const src = mkSrc('brown', 12);
  const lp1 = mkF('lowpass', 300, 0.5);
  const lp2 = mkF('lowpass', 120, 0.4);
  const tg  = mkG(0.7);
  const lfo = AC.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = 0.10;
  const lg  = mkG(0.25);
  lfo.connect(lg); lg.connect(tg.gain);
  tg.gain.setValueAtTime(0.70, AC.currentTime);
  src.connect(lp1); lp1.connect(lp2); lp2.connect(tg); tg.connect(MG);
  src.start(); lfo.start();
  stopFns.push(() => { try { src.stop(); lfo.stop(); } catch(e){} });
}

// â”€â”€ FOREST: Light wind + pure sine bird calls â”€â”€
function startForest() {
  const src = mkSrc('pink', 10);
  const bp  = mkF('bandpass', 500, 0.25);
  const lp  = mkF('lowpass', 1000, 0.5);
  const g   = mkG(0.35);
  src.connect(bp); bp.connect(lp); lp.connect(g); g.connect(MG);
  src.start();
  stopFns.push(() => { try { src.stop(); } catch(e){} });
  let alive = true;
  function chirp() {
    if (!alive) return;
    const t = AC.currentTime;
    const bases = [1320,1480,1640,1800,2000];
    const root  = bases[Math.floor(Math.random()*bases.length)];
    const count = 2 + Math.floor(Math.random()*2);
    for (let k = 0; k < count; k++) {
      const f = root + k*55;
      const o = AC.createOscillator(); o.type = 'sine';
      o.frequency.setValueAtTime(f, t+k*0.16);
      o.frequency.linearRampToValueAtTime(f+60, t+k*0.16+0.12);
      const env = mkG(0);
      env.gain.setValueAtTime(0, t+k*0.16);
      env.gain.linearRampToValueAtTime(0.032, t+k*0.16+0.025);
      env.gain.exponentialRampToValueAtTime(0.0001, t+k*0.16+0.18);
      o.connect(env); env.connect(MG);
      o.start(t+k*0.16); o.stop(t+k*0.16+0.22);
    }
    setTimeout(chirp, 2200 + Math.random()*4000);
  }
  chirp();
  stopFns.push(() => { alive = false; });
}

// â”€â”€ FIREPLACE: Warm brown noise + soft crackles â”€â”€
function startFire() {
  const src = mkSrc('brown', 10);
  const hp  = mkF('highpass', 50,  0.4);
  const ls  = mkF('lowshelf', 180, undefined, 7);
  const pk  = mkF('peaking',  500, 1.2, 5);
  const lp  = mkF('lowpass',  2000, 0.35);
  const g   = mkG(0.7);
  src.connect(hp); hp.connect(ls); ls.connect(pk); pk.connect(lp); lp.connect(g); g.connect(MG);
  src.start();
  stopFns.push(() => { try { src.stop(); } catch(e){} });
  let alive = true;
  function crk() {
    if (!alive) return;
    const t = AC.currentTime;
    const o = AC.createOscillator(); o.type = 'triangle';
    o.frequency.value = 150 + Math.random()*600;
    const env = mkG(0);
    env.gain.setValueAtTime(0, t);
    env.gain.linearRampToValueAtTime(0.012 + Math.random()*0.015, t+0.004);
    env.gain.exponentialRampToValueAtTime(0.0001, t+0.035);
    o.connect(env); env.connect(MG);
    o.start(t); o.stop(t+0.04);
    setTimeout(crk, 120 + Math.random()*350);
  }
  crk();
  stopFns.push(() => { alive = false; });
}

// â”€â”€ SPACE: Pure sine harmonic drones â”€â”€
function startSpace() {
  const freqs = [55, 82.4, 110, 146.8];
  const amps  = [0.18, 0.14, 0.11, 0.08];
  freqs.forEach((f, i) => {
    const o = AC.createOscillator(); o.type = 'sine'; o.frequency.value = f;
    const lfo = AC.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = 0.035 + i*0.011;
    const lg = mkG(f * 0.006); lfo.connect(lg); lg.connect(o.frequency);
    const g = mkG(0);
    o.connect(g); g.connect(MG);
    g.gain.setValueAtTime(0, AC.currentTime);
    g.gain.linearRampToValueAtTime(amps[i], AC.currentTime + 4);
    o.start(); lfo.start();
    stopFns.push(() => { try { o.stop(); lfo.stop(); } catch(e){} });
  });
}

const SOUND_META = {
  rain:   { name: 'Gentle Rain',     desc: 'Soft filtered pink noise' },
  ocean:  { name: 'Ocean Waves',     desc: 'Deep brown noise with slow swells' },
  forest: { name: 'Forest & Birds',  desc: 'Breeze with soft bird calls' },
  fire:   { name: 'Fireplace',       desc: 'Warm brown noise, soft crackles' },
  space:  { name: 'Deep Space',      desc: 'Pure harmonic sine drones' },
};

function playByName(name) {
  if      (name === 'rain')   startRain();
  else if (name === 'ocean')  startOcean();
  else if (name === 'forest') startForest();
  else if (name === 'fire')   startFire();
  else if (name === 'space')  startSpace();
}

function toggleSound(btn, name) {
  // Same sound â†’ stop
  if (activeSrc === name) {
    // Fade out
    const now = AC.currentTime;
    MG.gain.cancelScheduledValues(now);
    MG.gain.setValueAtTime(MG.gain.value, now);
    MG.gain.linearRampToValueAtTime(0, now + 0.3);
    setTimeout(() => {
      stopSound();
      MG.gain.setValueAtTime(vol, AC.currentTime);
    }, 320);
    document.querySelectorAll('.snd-btn').forEach(b => b.classList.remove('on'));
    document.getElementById('eq').classList.add('paused');
    document.getElementById('musicName').textContent = 'No sound selected';
    document.getElementById('musicDesc').textContent = 'Tap a sound below';
    LS.save('sound', null);                          // â† save
    return;
  }

  // Fade out old, start new
  if (AC && MG) {
    const now = AC.currentTime;
    MG.gain.cancelScheduledValues(now);
    MG.gain.setValueAtTime(MG.gain.value, now);
    MG.gain.linearRampToValueAtTime(0, now + 0.25);
    setTimeout(() => {
      stopSound();
      initAC();
      MG.gain.setValueAtTime(0, AC.currentTime);
      MG.gain.linearRampToValueAtTime(vol, AC.currentTime + 0.4);
      activeSrc = name;
      playByName(name);
    }, 280);
  } else {
    stopSound();
    initAC();
    activeSrc = name;
    playByName(name);
  }

  document.querySelectorAll('.snd-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  document.getElementById('eq').classList.remove('paused');
  const m = SOUND_META[name];
  document.getElementById('musicName').textContent = m.name;
  document.getElementById('musicDesc').textContent = m.desc;
  LS.save('sound', name);                            // â† save
  showToast('ğŸµ ' + m.name);
}

function setVol(v) {
  vol = parseFloat(v);
  if (MG) {
    const t = AC.currentTime;
    MG.gain.cancelScheduledValues(t);
    MG.gain.setValueAtTime(MG.gain.value, t);
    MG.gain.linearRampToValueAtTime(vol, t + 0.05);
  }
  LS.save('vol', vol);                               // â† save
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMode(m, el) {
  if (running) stopTimer();
  mode = m;
  document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.body.classList.toggle('break-mode', m !== 'focus');
  resetTimer();
}

function getModeTime()  { return S[mode] || S.focus; }
function getModeLabel() { return mode==='focus'?'DEEP FOCUS':mode==='short'?'SHORT BREAK':'LONG BREAK'; }

function resetTimer() {
  stopTimer();
  timeLeft = totalTime = getModeTime() * 60;
  updateDisp(); updateProg();
}

function toggleTimer() { running ? stopTimer() : startTimer(); }

function startTimer() {
  initAC();
  running = true;
  document.getElementById('startBtn').textContent = 'â¸';
  document.getElementById('startBtn').classList.add('running');
  // Resume sound
  if (activeSrc) {
    stopFns.forEach(fn => { try { fn(); } catch(e){} });
    stopFns = [];
    const prev = activeSrc; activeSrc = null;
    activeSrc = prev;
    MG.gain.setValueAtTime(0, AC.currentTime);
    MG.gain.linearRampToValueAtTime(vol, AC.currentTime + 0.4);
    playByName(prev);
    document.getElementById('eq').classList.remove('paused');
  }
  if (mode === 'focus') setupGuard();
  ticker = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) { timeLeft = 0; updateDisp(); updateProg(); onDone(); return; }
    updateDisp(); updateProg();
  }, 1000);
}

function stopTimer() {
  running = false;
  clearInterval(ticker); ticker = null;
  document.getElementById('startBtn').textContent = 'â–¶';
  document.getElementById('startBtn').classList.remove('running');
  removeGuard();
  // Pause: stop nodes, keep activeSrc name
  const was = activeSrc;
  if (AC && MG && was) {
    const now = AC.currentTime;
    MG.gain.cancelScheduledValues(now);
    MG.gain.setValueAtTime(MG.gain.value, now);
    MG.gain.linearRampToValueAtTime(0, now + 0.2);
    setTimeout(() => {
      stopFns.forEach(fn => { try { fn(); } catch(e){} });
      stopFns = [];
      activeSrc = was;
      if (MG) MG.gain.setValueAtTime(vol, AC.currentTime);
    }, 220);
    document.getElementById('eq').classList.add('paused');
  }
}

function skipSession() { stopTimer(); onDone(); }

function onDone() {
  const was = activeSrc;
  stopFns.forEach(fn => { try { fn(); } catch(e){} });
  stopFns = [];
  activeSrc = was;
  clearInterval(ticker); ticker = null;
  running = false;
  document.getElementById('startBtn').textContent = 'â–¶';
  document.getElementById('startBtn').classList.remove('running');
  removeGuard();
  playDone();

  if (mode === 'focus') {
    completedSessions++;
    stats.total++;
    stats.todayCount++;
    stats.todayDate = todayStr;
    const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
    const yStr = yesterday.toDateString();
    if (stats.lastDate === yStr) stats.streak++;
    else if (stats.lastDate !== todayStr) stats.streak = 1;
    stats.lastDate = todayStr;
    LS.save('stats', stats);                         // â† save
    updateStats(); updateDots();
    showToast('ğŸ‰ Session complete!');
    setTimeout(() => switchMode(completedSessions % 4 === 0 ? 'long' : 'short'), 1500);
  } else {
    showToast('ğŸ’ª Break over â€” back to focus!');
    setTimeout(() => switchMode('focus'), 1500);
  }
}

function switchMode(m) {
  mode = m;
  document.querySelectorAll('.mode-tab').forEach((t, i) => {
    t.classList.remove('active');
    if ((i===0&&m==='focus')||(i===1&&m==='short')||(i===2&&m==='long')) t.classList.add('active');
  });
  document.body.classList.toggle('break-mode', m !== 'focus');
  resetTimer();
}

function playDone() {
  try {
    initAC();
    [523, 659, 784, 1047].forEach((f, i) => {
      const o = AC.createOscillator(); o.type = 'sine'; o.frequency.value = f;
      const g = AC.createGain();
      g.gain.setValueAtTime(0, AC.currentTime + i*0.22);
      g.gain.linearRampToValueAtTime(0.18, AC.currentTime + i*0.22 + 0.02);
      g.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + i*0.22 + 0.5);
      o.connect(g); g.connect(AC.destination);
      o.start(AC.currentTime + i*0.22);
      o.stop(AC.currentTime + i*0.22 + 0.55);
    });
  } catch(e) {}
}

function updateDisp() {
  const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
  const s = (timeLeft%60).toString().padStart(2,'0');
  document.getElementById('timerDisplay').textContent = `${m}:${s}`;
  document.getElementById('timerLabel').textContent = getModeLabel();
  document.title = `${m}:${s} â€” Focus Timer`;
}
function updateProg() {
  const p = totalTime > 0 ? timeLeft / totalTime : 1;
  document.getElementById('timerProgress').style.strokeDashoffset = 678.6 * (1 - p);
}
function updateDots() {
  document.querySelectorAll('.pomo-dot').forEach((d, i) => {
    d.className = 'pomo-dot';
    const s = completedSessions % 4;
    if (i < s) d.classList.add('done'); else if (i === s) d.classList.add('current');
  });
  document.getElementById('sessionCount').textContent = `Session ${(completedSessions%4)+1} of 4 ğŸ…`;
}
function updateStats() {
  document.getElementById('statToday').textContent  = stats.todayCount;
  document.getElementById('statTotal').textContent  = stats.total;
  document.getElementById('statStreak').textContent = stats.streak;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function adj(type, delta) {
  S[type] = Math.max(1, S[type] + delta);
  document.getElementById(type+'Input').value = S[type];
  LS.save('settings', S);                            // â† save
  if (mode === type && !running) resetTimer();
}
function inp(type, val) {
  const n = parseInt(val);
  if (!isNaN(n) && n >= 1) {
    S[type] = n;
    LS.save('settings', S);                          // â† save
    if (mode === type && !running) resetTimer();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GUARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupGuard() {
  window.addEventListener('beforeunload', onUnload);
  document.addEventListener('visibilitychange', onVis);
}
function removeGuard() {
  window.removeEventListener('beforeunload', onUnload);
  document.removeEventListener('visibilitychange', onVis);
}
function onUnload(e) { if(running&&mode==='focus'){e.preventDefault();e.returnValue='You still have time left!';} }
function onVis() { if (document.hidden && running && mode==='focus') showGuard(); }
function showGuard() {
  document.getElementById('guard').classList.add('show');
  guardVal = 5; document.getElementById('gCount').textContent = guardVal;
  guardTick = setInterval(() => {
    guardVal--; document.getElementById('gCount').textContent = guardVal;
    if (guardVal <= 0) hideGuard();
  }, 1000);
}
function hideGuard() { clearInterval(guardTick); document.getElementById('guard').classList.remove('show'); }
function returnToStudy() { hideGuard(); showToast('ğŸ’ª Welcome back! Keep going!'); }
function forceLeave() { hideGuard(); stopTimer(); showToast('âš ï¸ Session paused.'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PWA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault(); deferredPrompt = e;
  document.getElementById('installBar').classList.add('show');
});
window.addEventListener('appinstalled', () => {
  document.getElementById('installBar').classList.remove('show');
  showToast('âœ… App installed!');
});
function doInstall() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(r => {
    if (r.outcome==='accepted') document.getElementById('installBar').classList.remove('show');
    deferredPrompt = null;
  });
}
function dismissInstall() { document.getElementById('installBar').classList.remove('show'); }

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(() => {});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT â€” restore everything from localStorage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init() {
  // Restore settings inputs
  document.getElementById('focusInput').value = S.focus;
  document.getElementById('shortInput').value = S.short;
  document.getElementById('longInput').value  = S.long;

  // Restore volume slider
  document.getElementById('volSlider').value = savedVol;
  vol = savedVol;

  // Restore stats display
  updateStats();
  updateDots();

  // Restore selected sound button highlight (no auto-play â€” needs user gesture first)
  if (savedSound) {
    activeSrc = savedSound;
    const btn = document.getElementById('sb-' + savedSound);
    if (btn) {
      btn.classList.add('on');
      const m = SOUND_META[savedSound];
      if (m) {
        document.getElementById('musicName').textContent = m.name;
        document.getElementById('musicDesc').textContent = m.desc + ' Â· press â–¶ to hear';
      }
    }
  }

  // Show initial timer
  resetTimer();
})();
</script>
</body>
</html>
